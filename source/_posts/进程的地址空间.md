title: 进程地址空间
author: weihehe
tags:
  - 内存
  - 中断
  - 惰性加载
  - 进程
categories:
  - 操作系统
date: 2024-07-14 21:20:00
---
解释虚拟地址和写实拷贝的数据解耦问题
<!--more-->
## 结构

- 对于每个进程的**内核PCB结构**来说，其中都**存储了`进程地址空间`结构的地址**。

### 什么叫进程地址空间？

- 进程地址空间，本质上是一个描述进程可用地址范围的大小。

- 进程地址空间存储着**进程运行时**所需要的数据的**虚拟地址**。经过**页表**映射才能访问到**物理地址**。

#### 进程地址空间的作用

- **避免将所有数据直接记录到物理内存中**，方便管理，让我们以**统一结构的视角看待内存**，即在**虚拟内存中各个空间对应的地址有序固定，而实际映射的物理内存的位置并不固定**。

![地址空间](/images/进程地址空间.png)

### 进程地址空间的区域划分（mm_struct）

![mm_struct的部分字段](/images/进程地址空间-mm_struct.png)
- 如上图所示，地址空间中存在各种各样的区域。我们通过记录**每个区域的起始地址和结束地址**，就可以将各个区域划分开来。

- 如果超过了规定的值，就称为**越界**。

### 页表
`k-V`


|虚拟地址 | 物理地址 | 标志位 | 代码或者数据是否已经载入到内存
| ---- | ---- | ----- |---|
|0x123 | 0x321 | rw | 1|

- rw：可读可写
- 1：已经被加载

![页表例图](/images/pasted-18.png)
`例如:`

- CPU中，存在一个`cr3`寄存器，存储着当前页表的起始地址，并且在**进程切换的时候**，页表的地址也会被`现场保护`。

- 根据**记录的虚拟地址找到物理地址。**

#### 页表的作用

- **权限管理——利用页表记录的标志位，可以检查内存操作是否违规**。
例如：如果有一个变量位于常量区，那么它的标志位为r(只读)，如果尝试w(写入)的时候，就会被阻拦。

- **拦截越界**如果在转换过程中**内存出现了异常访问，直接进行拦截。**从而这个请求不会抵达物理内存，从而保护物理内存。

### 父子进程

- 子进程在创建时，也会**基于父进程**创建属于自己的**页表**和**进程地址空间**。
![进程fork前后程序逻辑](/images/fork.png)

#### 写实拷贝--操作系统自动完成的

1. 当子程序有对数据进行修改，并且通过页表访问到的**物理地址和父进程的地址**是同一个的时候。

2. 就调整**子进程的页表**，将重新分配一块区域并记录到子程序的页表中。

（注意，这里没有修改虚拟地址，所以**父子进程的虚拟地址还可能相同**）

## 惰性加载

运行一个程序时，并不会将它对应磁盘的数据都加入到内存中，而时**分批加载**。

并且，如果短期内不会使用的数据，并不会被加载到内存 —— **惰性加载**。*页表中会进行记录。*

因此，我们在创建一个进程的时候，**先创建内核数据结构，再加载对应的可执行程序**。

## 总结：

**进程地址空间和页表**，实现了**进程管理模块**和**内存管理模块的解耦**。