title: 磁盘 Linux文件系统
author: weihehe
tags:
  - 文件
categories:
  - 操作系统
date: 2024-07-18 08:04:00
---
结论和概论
<!--more-->

## 磁盘

### 磁盘的组成
- 磁头（head）：不用说，主要就是读取磁盘表面磁方向和改变其方向，每个盘面有一个磁头，它极其贴近地悬浮在盘面上，但是绝对不与盘面接触，否则会损坏磁头和盘面；

- 磁道（track）：磁道是单个盘面上的同心圆，当磁盘旋转时，磁头若保持在一个位置上，则每个磁头都会在磁盘表面划出一个圆形轨迹，这些圆形轨迹就叫做磁道，一个盘面上的磁道可以有成千上万个。相邻磁道之间并不是紧挨着的，这是因为磁化单元相隔太近时磁性会产生相互影响，同时也为磁头的读写带来困难。

- 柱面（cylinder）：在有多个盘片构成的盘组中，由不同盘片的面，但处于同一半径圆的多个磁道组成的一个圆柱面。

- 扇区（sector）：磁盘上的每个磁道被等分为若干个弧段，这些弧段便是硬盘的扇区（Sector）。硬盘的第一个扇区，叫做引导扇区。扇区是被间隙（gap）分割的圆的片段，间隙未被磁化成0或者1。注意，扇区是读写磁盘最基本的单位，如果一个扇区因为某种原因被破坏，那么整个扇区的数据都会受影响。

![磁盘](/images/Linux文件管理-磁盘.png)

## Linux系统和磁盘
- Linux的文件在磁盘中存储时，**文件和属性** 是分开存储的。

- 磁盘被访问的基本单位时扇区，大小可能是512个字节等（以下统一将扇区当作`512字节`处理）。

- 我们可以把磁盘看成是**无数个扇区构成的存储介质**，我们可以把数据存到磁盘，第一个解决的问题是定位扇区。


- 如何定位？
	- 哪一个柱面（Cylinder）
	- 哪一个磁道（Heade）
	- 哪一个扇区（Sector）
	- 即CHS寻址方式
    

- 如何判断磁盘的效率高低呢？
	- 运动越少，效率越高
	- 运动越多。效率越低

### 逻辑关系（LBA地址法）


- 磁盘文件在逻辑上，我们将它们看成是线性的连续的。

假设现有一个盘面有`20000`个扇区，每个盘面有`50`个磁道，每个磁道有`400`个扇区。现有一块数据的编号是`28888`那么，我们可以得知：

1. 28888/20000 = 1（第一盘面）
2. 28888%20000 = 8888 --> 8888/400 = 22(第22号磁道)
3. 8888 % 400 = 88（第88号扇区）

以上方法即可以访问磁盘文件的方法。

## 外设寄存器

不仅仅是CPU具有寄存器，其他的外设也有。例如磁盘中：

- 控制寄存器：控制IO方向(r/w)。
- 数据寄存器：存放数据。
- 地址寄存器：地址寄存器(填写LBA)。
- 状态寄存器：检查是否操作成功。

## 管理分区

假如我们有一个800G的磁盘，系统在管理的时候，会对它进行**分区**。

- 其中记录分区的一种方法和我们在`进程地址空间`内描述的类似。

- 使用一个有关分区的结构体数组，每一个结构体内包含这个分区的起始地址和结束地址。

### 块

对于一个分区，会再将它**划分为多个块区**。

![分区和块](/images/文件管理-快.png)

- `boot block` :包含一些操作系统启动的一些信息。

- `Date blocks`：存取操作的区域，都是以**块的字节大小**来操作的,常见的是4KB大小。并且一个分区支持有多个`Date blocks`。

- `inode Table`：用来记录多个`inode`——其中`Date blocks`的属性。并且`inode`有**唯一的编号**。

- `block Bitmap`：比特位和块号之间的映射，其**映射关系是该块号是否有被使用过**。

- `inode Bitmap`：其**映射关系是该inode编号是否有效**

**删除文件只需要将文件对应的位图(`inode`和`block`的`Bitmap`)初始化即可**——这也就是一般删除文件速度很快的原因。也是可以恢复数据的原因。


故Linux中，磁盘文件是**属性和数据是分开存储的**。

### inode

对于一个`inode`结构来说，它内部存在一个用来记录`块`的数组。用来快速找到磁盘文件存储数据的位置。但其寻找策略也有区别：

- 直接索引 —— 直接存储文件内容。

- 间接索引（二三级索引等） —— 不存文件内容，而是存储文件的块号内容。（只有索引的`叶子节点`才存储文件内容）

### 特性

- 一个分区里能使用的`inode`数量，在格式化的时候就确定好了。

---
[磁盘原理介绍](https://zhuanlan.zhihu.com/p/89505052)