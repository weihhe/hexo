title: TCP通信原理
author: weihehe
tags:
  - TCP
categories:
  - 网络
date: 2024-08-18 13:51:00
---
概念原理
<!--more-->

## 基础

1. TCP通信是全双工的。
	- 全双工的原因：其套接字在操作系统中都有独立的发送缓冲区和接收缓冲区。
	- read/wirte类似一种拷贝函数，负责**用户数据与系统缓冲区之间的数据传递**。然后由**传输控制协议**决定数据的收发。
    
![TCP通信原理](/images/TCP通信原理.png)

### 建立连接的过程

1. 调用 `socket` 创建文件描述符。
2. 调用 `connect` 向服务器发起连接请求。
3. `connect` 会发出 SYN 段并阻塞等待服务器应答。(第一次)
4. 服务器收到客户端的 SYN，会应答一个 SYN-ACK 段，表示"同意建立连接"。(第二次)
5. 客户端收到 SYN-ACK 后会从 `connect()` 返回，同时应答一个 ACK 段。(第三次)

这个建立连接的过程通常称为 **三次握手**。

### 数据传输的过程

- 建立连接后，TCP 协议提供全双工的通信服务。

- 服务器从 `accept()` 返回后立刻调用 `read()`，读 socket 就像读管道一样，如果没有数据到达就阻塞等待。

- 这时客户端调用 `write()` 发送请求给服务器，服务器收到后从 `read()` 返回，对客户端的请求进行处理，在此期间客户端调用 `read()` 阻塞等待服务器的应答。

- 服务器调用 `write()` 将处理结果发回给客户端，再次调用 `read()` 阻塞等待下一条请求。

- 客户端收到后从 `read()` 返回，发送下一条请求，如此循环下去。

## 断开连接的过程

1. 如果客户端没有更多的请求了，就调用 `close()` 关闭连接，客户端会向服务器发送 FIN 段。(第一次)
2. 服务器收到 FIN 后，会回应一个 ACK，同时 `read` 会返回 0。(第二次)
3. `read` 返回之后，服务器就知道客户端关闭了连接，也调用 `close` 关闭连接，这个时候服务器会向客户端发送一个 FIN。(第三次)
4. 客户端收到 FIN，再返回一个 ACK 给服务器。(第四次)

这个断开连接的过程通常称为 **四次挥手**。